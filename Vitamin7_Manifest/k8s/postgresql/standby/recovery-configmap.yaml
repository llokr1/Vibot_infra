apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-recovery-config
  namespace: postgresql-backup
data:
  # Standby 초기화 스크립트
  init-standby.sh: |
    #!/bin/bash
    set -e
    
    echo "Initializing PostgreSQL Standby..."
    
    # Primary DB가 준비될 때까지 대기
    until pg_isready -h ${POSTGRES_MASTER_SERVICE} -U ${POSTGRES_REPLICATION_USER}; do
      echo "Waiting for primary DB to be ready..."
      sleep 5
    done
    
    # 데이터 디렉토리가 비어있으면 base backup 수행
    if [ ! -f "$PGDATA/PG_VERSION" ]; then
      echo "Performing base backup from primary..."
      PGPASSWORD=${POSTGRES_REPLICATION_PASSWORD} pg_basebackup \
        -h ${POSTGRES_MASTER_SERVICE} \
        -U ${POSTGRES_REPLICATION_USER} \
        -D ${PGDATA} \
        -P \
        -W \
        -R \
        -X stream \
        -v
      
      echo "Base backup completed"
    else
      echo "Data directory already exists, skipping base backup"
    fi
    
    echo "Standby initialization completed"
  
  # recovery.conf (PostgreSQL 12+는 postgresql.auto.conf 사용)
  postgresql.auto.conf: |
    # Standby 모드 설정
    primary_conninfo = 'host=${POSTGRES_MASTER_SERVICE} port=5432 user=${POSTGRES_REPLICATION_USER} password=${POSTGRES_REPLICATION_PASSWORD}'
    primary_slot_name = 'backup_slot'
    # Failover 트리거 파일
    trigger_file = '/var/lib/postgresql/data/pgdata/failover.trigger'
    # Hot Standby 설정
    hot_standby = on
    hot_standby_feedback = on




